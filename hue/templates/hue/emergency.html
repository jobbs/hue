{% extends 'base.html' %}
{% block title %}- View {% endblock %}
{% block content %}
<div id="map" style="width:100%;height:400px;"></div>

<script>
var pos = [];
{% for data in pos %}
pos.push({'deviceUuid': '{{data.deviceUuid}}', 'deviceLng': '{{data.deviceLng}}', 'deviceLat': '{{data.deviceLat}}', 'deviceState': '{{data.deviceState}}', 'callDate': '{{data.callDate}}' });
{% endfor %}
pos.sort(function(a, b) {
    a = new Date(a.callDate);
    b = new Date(b.callDate);
    return a>b ? -1 : a<b ? 1 : 0;
});
pos.sort((a,b) => (a.deviceUuid > b.deviceUuid) ? 1 : ((b.deviceUuid > a.deviceUuid) ? -1 : 0));
var finalArray = getUniqueObjectArray(pos);
var mapOptions = {
    center: new naver.maps.LatLng(36.302726, 127.381359),
    zoom: 8
};

var map = new naver.maps.Map('map', mapOptions);
var markers = [],
    infoWindows = [];
var cnt = 0;

for (var key in finalArray) {
    cnt++;
    var position = new naver.maps.LatLng(
        finalArray[key].deviceLat,
        finalArray[key].deviceLng);

    var marker = new naver.maps.Marker({
        map: map,
        position: position,
        title: finalArray[key].deviceUuid,
        zIndex: 100
    });
    console.log(marker);
    var infoWindow = new naver.maps.InfoWindow({
        content: '<div style="width:150px;text-align:center;padding:10px;">The Letter is <b>"'+ key.substr(0, 1) +'"</b>.</div>'
    });
    marker._nmarker_id = finalArray[key].deviceUuid;
    markers.push(marker);
    infoWindows.push(infoWindow);
};


function changePos(arr){

$.ajax({
    type: "POST", // 데이터를 전송하는 방법을 지정
    url: "/emergency/signal", // 통신할 url을 지정
    data: {'signalData[]': data, 'csrfmiddlewaretoken': '{{ csrf_token }}'}, // 서버로 데이터 전송시 옵션
    dataType: "json", // 서버측에서 전송한 데이터를 어떤 형식의 데이터로서 해석할 것인가를 지정, 없으면 알아서 판단
    // 서버측에서 전송한 Response 데이터 형식 (json)
    success: function(response){ // 통신 성공시
      signalArr = [];
      temp = response.result.sort();
      temp.sort(function(a, b) {
            a = new Date(a.callDate);
            b = new Date(b.callDate);
            return a>b ? -1 : a<b ? 1 : 0;
        });
        temp.sort((a,b) => (a.deviceUuid > b.deviceUuid) ? 1 : ((b.deviceUuid > a.deviceUuid) ? -1 : 0));
        var periodResultArray = getUniqueObjectArray(temp);
       for(var i =0; i<markers.length; i++){
           for(var j=0; j< periodResultArray; j++){
               if(markers[i].title == periodResultArray[j].deviceUuid){
                 console.log(markers[i]);
                 console.log(markers[i].title);
                 var newPos = new naver.maps.LatLng(periodResultArray[j].deviceLat, periodResultArray[j].deviceLng);
                 markers[i].setPosition(newPos);
               }
           }
        }
    },
    error: function(request, status, error){ // 통신 실패시 - 로그인 페이지 리다이렉트
      signalArr = [];
    }
  });
}

</script>
{% endblock %}